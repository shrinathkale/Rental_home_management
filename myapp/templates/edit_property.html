{% extends 'base.html' %}
{% block content %}

<div class="container">
<div class="card shadow mt-5">
    <div class="card-body">
        <h2 class="card-title mb-4">Edit Property</h2>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Section 1: Basic Room Information -->
            <h4 class="mt-4 mb-3 border-bottom pb-2">1Ô∏è‚É£ Basic Room Information</h4>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="title">Room Title / Name:</label>
                    {{ form.title }}
                    {% if form.title.errors %}<div class="text-danger">{{ form.title.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="room_type">Room Type:</label>
                    {{ form.room_type }}
                    {% if form.room_type.errors %}<div class="text-danger">{{ form.room_type.errors }}</div>{% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="flat_system">Flat System:</label>
                    {{ form.flat_system }}
                    {% if form.flat_system.errors %}<div class="text-danger">{{ form.flat_system.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="city">City:</label>
                    {{ form.city }}
                    {% if form.city.errors %}<div class="text-danger">{{ form.city.errors }}</div>{% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="area_location">Area / Location:</label>
                    {{ form.area_location }}
                    {% if form.area_location.errors %}<div class="text-danger">{{ form.area_location.errors }}</div>{% endif %}
                </div>
            </div>

            <div class="mb-3">
                <label for="full_address">Full Address:</label>
                {{ form.full_address }}
                {% if form.full_address.errors %}<div class="text-danger">{{ form.full_address.errors }}</div>{% endif %}
            </div>

            <!-- Section 1.5: Location Map -->
            <h4 class="mt-4 mb-3 border-bottom pb-2">üìç Property Location on Map</h4>
            
            <div class="mb-3">
                <label>Choose Location Method:</label>
                <div class="btn-group mb-3" role="group">
                    <button type="button" class="btn btn-outline-primary" id="btn-search" onclick="toggleSearchMode()">üîç Search Address</button>
                    <button type="button" class="btn btn-outline-primary active" id="btn-map" onclick="toggleMapMode()">üìå Click on Map</button>
                    <button type="button" class="btn btn-outline-primary" id="btn-location" onclick="getCurrentLocation()">üìç My Location</button>
                </div>
            </div>

            <!-- Search Box -->
            <div id="search-container" class="mb-3" style="display: none;">
                <input type="text" id="address-search" class="form-control" placeholder="Type your property address here...">
                <small class="text-muted">Start typing and select from suggestions</small>
            </div>

            <!-- Map Container -->
            <div id="map-container" class="mb-3">
                <div id="property-map" style="width: 100%; height: 400px; border: 2px solid #ddd; border-radius: 5px;"></div>
                <small class="text-muted mt-2">Click on the map to place the pin at your property location, or drag the pin to adjust</small>
            </div>

            <!-- Coordinates Display (Hidden from user but captured) -->
            <div class="row mt-3">
                <div class="col-md-6 mb-3">
                    <label for="latitude">Latitude (Auto-filled):</label>
                    {{ form.latitude }}
                    <small class="text-muted d-block">This will be automatically set by selecting location</small>
                    {% if form.latitude.errors %}<div class="text-danger">{{ form.latitude.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="longitude">Longitude (Auto-filled):</label>
                    {{ form.longitude }}
                    <small class="text-muted d-block">This will be automatically set by selecting location</small>
                    {% if form.longitude.errors %}<div class="text-danger">{{ form.longitude.errors }}</div>{% endif %}
                </div>
            </div>

            <!-- Section 2: Pricing & Capacity -->
            <h4 class="mt-4 mb-3 border-bottom pb-2">2Ô∏è‚É£ Pricing & Capacity</h4>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="monthly_rent">Monthly Rent (‚Çπ):</label>
                    {{ form.monthly_rent }}
                    {% if form.monthly_rent.errors %}<div class="text-danger">{{ form.monthly_rent.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="security_deposit">Security Deposit (‚Çπ):</label>
                    {{ form.security_deposit }}
                    {% if form.security_deposit.errors %}<div class="text-danger">{{ form.security_deposit.errors }}</div>{% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="maintenance_charges">Maintenance Charges (‚Çπ):</label>
                    {{ form.maintenance_charges }}
                    {% if form.maintenance_charges.errors %}<div class="text-danger">{{ form.maintenance_charges.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="max_people">Maximum People Allowed:</label>
                    {{ form.max_people }}
                    {% if form.max_people.errors %}<div class="text-danger">{{ form.max_people.errors }}</div>{% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="per_person_rent">Per Person Rent (‚Çπ):</label>
                    {{ form.per_person_rent }}
                    {% if form.per_person_rent.errors %}<div class="text-danger">{{ form.per_person_rent.errors }}</div>{% endif %}
                </div>
            </div>

            <!-- Section 3: Room Images -->
            <h4 class="mt-4 mb-3 border-bottom pb-2">3Ô∏è‚É£ Room Images</h4>

            <div class="mb-3">
                <label for="main_image">Main Room Image:</label>
                {{ form.main_image }}
                {% if form.main_image.errors %}<div class="text-danger">{{ form.main_image.errors }}</div>{% endif %}
            </div>

            <!-- Section 4: Room Details -->
            <h4 class="mt-4 mb-3 border-bottom pb-2">4Ô∏è‚É£ Room Details</h4>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="floor_number">Floor Number:</label>
                    {{ form.floor_number }}
                    {% if form.floor_number.errors %}<div class="text-danger">{{ form.floor_number.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="total_floors">Total Floors:</label>
                    {{ form.total_floors }}
                    {% if form.total_floors.errors %}<div class="text-danger">{{ form.total_floors.errors }}</div>{% endif %}
                </div>
            </div>

            <div class="mb-3">
                <label for="furnishing_status">Furnishing Status:</label>
                {{ form.furnishing_status }}
                {% if form.furnishing_status.errors %}<div class="text-danger">{{ form.furnishing_status.errors }}</div>{% endif %}
            </div>

            <!-- Section 5: Amenities -->
            <h4 class="mt-4 mb-3 border-bottom pb-2">5Ô∏è‚É£ Amenities</h4>

            <div class="mb-3">
                <label>Select Amenities:</label>
                <div class="row">
                    {% for value, label in form.amenities.field.choices %}
                        <div class="col-md-6 mb-2">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="amenity_{{ value }}" 
                                       name="amenities" value="{{ value }}" 
                                       {% if value in form.amenities.value %}checked{% endif %}>
                                <label class="form-check-label" for="amenity_{{ value }}">{{ label }}</label>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Section 6: Nearby Places -->
            <h4 class="mt-4 mb-3 border-bottom pb-2">6Ô∏è‚É£ Nearby Places</h4>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="nearby_college_office">Nearby College / Office:</label>
                    {{ form.nearby_college_office }}
                    {% if form.nearby_college_office.errors %}<div class="text-danger">{{ form.nearby_college_office.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="nearby_mall">Nearby Mall:</label>
                    {{ form.nearby_mall }}
                    {% if form.nearby_mall.errors %}<div class="text-danger">{{ form.nearby_mall.errors }}</div>{% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="garden_park_nearby">Garden / Park Nearby:</label>
                    {{ form.garden_park_nearby }}
                    {% if form.garden_park_nearby.errors %}<div class="text-danger">{{ form.garden_park_nearby.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="hospital_medical">Hospital / Medical Store:</label>
                    {{ form.hospital_medical }}
                    {% if form.hospital_medical.errors %}<div class="text-danger">{{ form.hospital_medical.errors }}</div>{% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="temple_religious">Temple / Religious Place:</label>
                    {{ form.temple_religious }}
                    {% if form.temple_religious.errors %}<div class="text-danger">{{ form.temple_religious.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="bus_railway_distance">Bus Stop / Railway Station Distance:</label>
                    {{ form.bus_railway_distance }}
                    {% if form.bus_railway_distance.errors %}<div class="text-danger">{{ form.bus_railway_distance.errors }}</div>{% endif %}
                </div>
            </div>

            <!-- Section 7: Food & Mess -->
            <h4 class="mt-4 mb-3 border-bottom pb-2">7Ô∏è‚É£ Food & Mess</h4>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="mess_available" 
                               name="mess_available" value="on"
                               {% if form.mess_available.value %}checked{% endif %}>
                        <label class="form-check-label" for="mess_available">
                            Mess Available
                        </label>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="mess_type">Mess Type:</label>
                    {{ form.mess_type }}
                    {% if form.mess_type.errors %}<div class="text-danger">{{ form.mess_type.errors }}</div>{% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="mess_distance">Mess Distance:</label>
                    {{ form.mess_distance }}
                    {% if form.mess_distance.errors %}<div class="text-danger">{{ form.mess_distance.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="tiffin_available" 
                               name="tiffin_available" value="on"
                               {% if form.tiffin_available.value %}checked{% endif %}>
                        <label class="form-check-label" for="tiffin_available">
                            Tiffin Service Available
                        </label>
                    </div>
                </div>
            </div>

            <!-- Section 8: Rules & Preferences -->
            <h4 class="mt-4 mb-3 border-bottom pb-2">8Ô∏è‚É£ Rules & Preferences</h4>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="preferred_tenant_type">Preferred Tenant Type:</label>
                    {{ form.preferred_tenant_type }}
                    {% if form.preferred_tenant_type.errors %}<div class="text-danger">{{ form.preferred_tenant_type.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="gender_preference">Gender Preference:</label>
                    {{ form.gender_preference }}
                    {% if form.gender_preference.errors %}<div class="text-danger">{{ form.gender_preference.errors }}</div>{% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="smoking_allowed" 
                               name="smoking_allowed" value="on"
                               {% if form.smoking_allowed.value %}checked{% endif %}>
                        <label class="form-check-label" for="smoking_allowed">
                            Smoking Allowed
                        </label>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="drinking_allowed" 
                               name="drinking_allowed" value="on"
                               {% if form.drinking_allowed.value %}checked{% endif %}>
                        <label class="form-check-label" for="drinking_allowed">
                            Drinking Allowed
                        </label>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="pets_allowed" 
                               name="pets_allowed" value="on"
                               {% if form.pets_allowed.value %}checked{% endif %}>
                        <label class="form-check-label" for="pets_allowed">
                            Pets Allowed
                        </label>
                    </div>
                </div>
            </div>

            <!-- Section 9: Availability -->
            <h4 class="mt-4 mb-3 border-bottom pb-2">9Ô∏è‚É£ Availability</h4>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="available_from">Available From:</label>
                    {{ form.available_from }}
                    {% if form.available_from.errors %}<div class="text-danger">{{ form.available_from.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="min_stay_duration">Minimum Stay Duration (Months):</label>
                    {{ form.min_stay_duration }}
                    {% if form.min_stay_duration.errors %}<div class="text-danger">{{ form.min_stay_duration.errors }}</div>{% endif %}
                </div>
            </div>

            <!-- Section 10: Description -->
            <h4 class="mt-4 mb-3 border-bottom pb-2">üîü Description</h4>

            <div class="mb-3">
                <label for="description">Room Description:</label>
                {{ form.description }}
                {% if form.description.errors %}<div class="text-danger">{{ form.description.errors }}</div>{% endif %}
            </div>

            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary btn-lg flex-fill">Save Changes</button>
                <a href="/property/{{ property.id }}/" class="btn btn-secondary btn-lg flex-fill">Cancel</a>
            </div>
        </form>
    </div>
</div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places"></script>
<script>
    let map;
    let marker;
    let autocomplete;
    let searchMode = false;

    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        setupAddressSearch();
    });

    function initMap() {
        // Get existing coordinates from form
        const lat = parseFloat(document.getElementById('id_latitude').value) || 28.6139;
        const lng = parseFloat(document.getElementById('id_longitude').value) || 77.2090;
        
        const initialLocation = { lat: lat, lng: lng };

        map = new google.maps.Map(document.getElementById('property-map'), {
            zoom: 17,
            center: initialLocation,
            mapTypeControl: true,
            fullscreenControl: true,
            streetViewControl: true,
        });

        // Create marker
        marker = new google.maps.Marker({
            position: initialLocation,
            map: map,
            draggable: true,
            title: 'Your Property Location'
        });

        // Update coordinates when marker is dragged
        marker.addListener('dragend', function() {
            const position = marker.getPosition();
            updateCoordinates(position.lat(), position.lng());
        });

        // Update coordinates when map is clicked
        map.addListener('click', function(event) {
            marker.setPosition(event.latLng);
            updateCoordinates(event.latLng.lat(), event.latLng.lng());
        });

        // Update map center and marker when location changes
        map.addListener('center_changed', function() {
            // Optional: add logic here if needed
        });
    }

    function setupAddressSearch() {
        const searchInput = document.getElementById('address-search');
        
        autocomplete = new google.maps.places.Autocomplete(searchInput, {
            types: ['geocode'],
            componentRestrictions: { country: 'in' } // Focus on India
        });

        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            
            if (!place.geometry) {
                alert('Please select a valid location from the suggestions');
                return;
            }

            // Center map on selected place
            const location = place.geometry.location;
            map.setCenter(location);
            map.setZoom(17);
            
            // Move marker to selected location
            marker.setPosition(location);
            
            // Update coordinates
            updateCoordinates(location.lat(), location.lng());
            
            // Update address field
            document.getElementById('id_full_address').value = place.formatted_address || '';
        });
    }

    function updateCoordinates(lat, lng) {
        document.getElementById('id_latitude').value = lat.toFixed(6);
        document.getElementById('id_longitude').value = lng.toFixed(6);
    }

    function toggleSearchMode() {
        searchMode = !searchMode;
        const searchContainer = document.getElementById('search-container');
        const btnSearch = document.getElementById('btn-search');
        const btnMap = document.getElementById('btn-map');

        if (searchMode) {
            searchContainer.style.display = 'block';
            btnSearch.classList.add('active');
            btnMap.classList.remove('active');
            document.getElementById('address-search').focus();
        } else {
            searchContainer.style.display = 'none';
            btnSearch.classList.remove('active');
            btnMap.classList.add('active');
        }
    }

    function toggleMapMode() {
        searchMode = false;
        const searchContainer = document.getElementById('search-container');
        const btnSearch = document.getElementById('btn-search');
        const btnMap = document.getElementById('btn-map');
        
        searchContainer.style.display = 'none';
        btnSearch.classList.remove('active');
        btnMap.classList.add('active');
    }

    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Center map on user location
                const userLocation = { lat: lat, lng: lng };
                map.setCenter(userLocation);
                map.setZoom(17);
                
                // Move marker to user location
                marker.setPosition(userLocation);
                
                // Update coordinates
                updateCoordinates(lat, lng);
                
                alert('‚úì Your location has been set! You can adjust the marker if needed.');
            }, function() {
                alert('‚ö† Unable to get your location. Please allow location access or search manually.');
            });
        } else {
            alert('Geolocation is not supported by your browser.');
        }
    }

    // Make the map responsive
    window.addEventListener('resize', function() {
        if (map) {
            const center = map.getCenter();
            map.panTo(center);
        }
    });
</script>

{% endblock %}
