{% extends 'base.html' %}
{% block content %}

<div class="row mt-4">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-body">
                <h2 class="card-title">{{ property.title }}</h2>
                
                <!-- Main Image -->
                {% if property.main_image %}
                    <img src="{{ property.main_image.url }}" alt="{{ property.title }}" class="img-fluid rounded mb-3" style="max-height: 500px; width: 100%; object-fit: cover;">
                {% else %}
                    <div class="bg-light border rounded mb-3" style="max-height: 500px; width: 100%; display: flex; align-items: center; justify-content: center;">
                        <p class="text-muted">No image available</p>
                    </div>
                {% endif %}
                
                <!-- Additional Images -->
                {% if property.additional_images.all %}
                    <div class="row mb-3">
                        <h5>Gallery:</h5>
                        {% for image in property.additional_images.all %}
                            <div class="col-md-3 mb-2">
                                <img src="{{ image.image.url }}" alt="Property" class="img-fluid rounded" style="height: 150px; object-fit: cover;">
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Basic Information -->
                <section class="mt-4">
                    <h4 class="border-bottom pb-2">Property Details</h4>
                    <div class="row mt-3">
                        <div class="col-md-6 mb-3">
                            <strong>Room Type:</strong> {{ property.get_room_type_display }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Flat System:</strong> {{ property.get_flat_system_display }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>City:</strong> {{ property.city }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Area/Location:</strong> {{ property.area_location }}
                        </div>
                        <div class="col-md-12 mb-3">
                            <strong>Full Address:</strong> {{ property.full_address }}
                        </div>
                    </div>
                </section>

                <!-- Pricing & Capacity -->
                <section class="mt-4">
                    <h4 class="border-bottom pb-2">Pricing & Capacity</h4>
                    <div class="row mt-3">
                        <div class="col-md-6 mb-3">
                            <strong>Monthly Rent:</strong> <span class="text-primary">‚Çπ{{ property.monthly_rent }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Security Deposit:</strong> <span class="text-info">‚Çπ{{ property.security_deposit }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Maintenance Charges:</strong> ‚Çπ{{ property.maintenance_charges }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Per Person Rent:</strong> ‚Çπ{{ property.per_person_rent }}
                        </div>
                        <div class="col-md-12 mb-3">
                            <strong>Maximum People Allowed:</strong> {{ property.max_people }}
                        </div>
                    </div>
                </section>

                <!-- Room Details -->
                <section class="mt-4">
                    <h4 class="border-bottom pb-2">Room Details</h4>
                    <div class="row mt-3">
                        <div class="col-md-6 mb-3">
                            <strong>Floor Number:</strong> {{ property.floor_number }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Total Floors:</strong> {{ property.total_floors }}
                        </div>
                        <div class="col-md-12 mb-3">
                            <strong>Furnishing Status:</strong> {{ property.get_furnishing_status_display }}
                        </div>
                    </div>
                </section>

                <!-- Amenities -->
                {% if property.amenities %}
                    <section class="mt-4">
                        <h4 class="border-bottom pb-2">Amenities</h4>
                        <div class="mt-3">
                            {% for amenity in property.amenities_list %}
                                <span class="badge bg-secondary me-2 mb-2">{{ amenity|title }}</span>
                            {% endfor %}
                        </div>
                    </section>
                {% endif %}

                <!-- Nearby Places -->
                <section class="mt-4">
                    <h4 class="border-bottom pb-2">Nearby Places</h4>
                    <div class="row mt-3">
                        {% if property.nearby_college_office %}
                            <div class="col-md-6 mb-3">
                                <strong>College/Office:</strong> {{ property.nearby_college_office }}
                            </div>
                        {% endif %}
                        {% if property.nearby_mall %}
                            <div class="col-md-6 mb-3">
                                <strong>Nearby Mall:</strong> {{ property.nearby_mall }}
                            </div>
                        {% endif %}
                        {% if property.garden_park_nearby %}
                            <div class="col-md-6 mb-3">
                                <strong>Garden/Park:</strong> {{ property.garden_park_nearby }}
                            </div>
                        {% endif %}
                        {% if property.hospital_medical %}
                            <div class="col-md-6 mb-3">
                                <strong>Hospital/Medical:</strong> {{ property.hospital_medical }}
                            </div>
                        {% endif %}
                        {% if property.temple_religious %}
                            <div class="col-md-6 mb-3">
                                <strong>Temple/Religious:</strong> {{ property.temple_religious }}
                            </div>
                        {% endif %}
                        {% if property.bus_railway_distance %}
                            <div class="col-md-6 mb-3">
                                <strong>Bus Stop/Railway:</strong> {{ property.bus_railway_distance }}
                            </div>
                        {% endif %}
                    </div>
                </section>

                <!-- Food & Mess -->
                <section class="mt-4">
                    <h4 class="border-bottom pb-2">Food & Mess</h4>
                    <div class="mt-3">
                        <p>
                            <strong>Mess Available:</strong> 
                            {% if property.mess_available %}
                                <span class="badge bg-success">Yes - {{ property.get_mess_type_display }}</span>
                                {% if property.mess_distance %}
                                    <br><strong>Distance:</strong> {{ property.mess_distance }}
                                {% endif %}
                            {% else %}
                                <span class="badge bg-danger">No</span>
                            {% endif %}
                        </p>
                        <p>
                            <strong>Tiffin Service:</strong> 
                            {% if property.tiffin_available %}
                                <span class="badge bg-success">Available</span>
                            {% else %}
                                <span class="badge bg-secondary">Not Available</span>
                            {% endif %}
                        </p>
                    </div>
                </section>

                <!-- Rules & Preferences -->
                <section class="mt-4">
                    <h4 class="border-bottom pb-2">Rules & Preferences</h4>
                    <div class="mt-3">
                        <p><strong>Preferred Tenant Type:</strong> {{ property.get_preferred_tenant_type_display }}</p>
                        <p><strong>Gender Preference:</strong> {{ property.get_gender_preference_display }}</p>
                        <div>
                            {% if property.smoking_allowed %}
                                <span class="badge bg-warning">Smoking Allowed</span>
                            {% else %}
                                <span class="badge bg-secondary">No Smoking</span>
                            {% endif %}
                            
                            {% if property.drinking_allowed %}
                                <span class="badge bg-warning">Drinking Allowed</span>
                            {% else %}
                                <span class="badge bg-secondary">No Drinking</span>
                            {% endif %}
                            
                            {% if property.pets_allowed %}
                                <span class="badge bg-info">Pets Allowed</span>
                            {% else %}
                                <span class="badge bg-secondary">No Pets</span>
                            {% endif %}
                        </div>
                    </div>
                </section>

                <!-- Availability -->
                <section class="mt-4">
                    <h4 class="border-bottom pb-2">Availability</h4>
                    <div class="mt-3">
                        <p><strong>Available From:</strong> {{ property.available_from|date:"d M, Y" }}</p>
                        <p><strong>Minimum Stay:</strong> {{ property.min_stay_duration }} months</p>
                    </div>
                </section>

                <!-- Description -->
                <section class="mt-4">
                    <h4 class="border-bottom pb-2">Description</h4>
                    <p class="mt-3">{{ property.description }}</p>
                </section>

                <!-- Location Map (Visible only after booking acceptance) -->
                {% if booking_request and booking_request.status == 'accepted' and property.latitude and property.longitude %}
                    <section class="mt-4">
                        <h4 class="border-bottom pb-2">üìç Property Location Map</h4>
                        <div id="property-map-detail" style="width: 100%; height: 400px; margin-top: 20px; border: 2px solid #ddd; border-radius: 5px;"></div>
                        <p class="text-muted small mt-2">
                            <strong>Coordinates:</strong> Latitude: {{ property.latitude }}, Longitude: {{ property.longitude }}
                        </p>
                    </section>
                {% elif booking_request and booking_request.status == 'accepted' %}
                    <section class="mt-4">
                        <div class="alert alert-info">
                            <strong>‚Ñπ Map information:</strong> The property owner has not provided location coordinates yet. Please contact them for directions.
                        </div>
                    </section>
                {% endif %}

                <!-- Owner Information -->
                <section class="mt-4">
                    <h4 class="border-bottom pb-2">Property Owner</h4>
                    <div class="mt-3">
                        <p><strong>Name:</strong> {{ property.owner.get_full_name|default:property.owner.username }}</p>
                        <p><strong>Email:</strong> {{ property.owner.email }}</p>
                        {% if property.owner.profile.phone %}
                            <p><strong>Phone:</strong> {{ property.owner.profile.phone }}</p>
                        {% endif %}
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Sidebar: Booking Section -->
    <div class="col-lg-4" id="booking-section">
        <div class="card shadow sticky-top" style="top: 20px;">
            <div class="card-body">
                <h4 class="card-title mb-4">Book Now</h4>

                <!-- Booking Status -->
                {% if booking_request %}
                    <div class="alert alert-info mb-4">
                        <strong>Booking Status:</strong><br>
                        <span class="badge bg-{% if booking_request.status == 'accepted' %}success{% elif booking_request.status == 'rejected' %}danger{% elif booking_request.status == 'pending' %}warning{% else %}secondary{% endif %}">
                            {{ booking_request.get_status_display|upper }}
                        </span>
                        
                        {% if booking_request.status == 'accepted' %}
                            <p class="mt-2 text-success">
                                <strong>‚úì Your booking has been accepted!</strong><br>
                                The property owner has accepted your booking request. Please contact the owner for further details.
                            </p>
                        {% elif booking_request.status == 'rejected' %}
                            <p class="mt-2 text-danger">
                                <strong>‚úó Your booking request was rejected.</strong><br>
                                {% if booking_request.owner_response %}
                                    Owner's Response: {{ booking_request.owner_response }}
                                {% endif %}
                            </p>
                        {% elif booking_request.status == 'pending' %}
                            <p class="mt-2 text-warning">
                                <strong>‚è≥ Your booking request is pending.</strong><br>
                                The owner will respond to your request soon.
                            </p>
                        {% endif %}
                        
                        <hr>
                        <small>Requested on: {{ booking_request.requested_at|date:"d M, Y H:i" }}</small>
                        {% if booking_request.responded_at %}
                            <br><small>Responded on: {{ booking_request.responded_at|date:"d M, Y H:i" }}</small>
                        {% endif %}
                    </div>
                {% endif %}

                <!-- Availability Status -->
                <div class="mb-4">
                    {% if property.available %}
                        <span class="badge bg-success" style="font-size: 0.95rem; padding: 0.5rem 0.75rem;">‚úì Available</span>
                    {% else %}
                        <span class="badge bg-danger" style="font-size: 0.95rem; padding: 0.5rem 0.75rem;">‚úó Unavailable</span>
                        <div class="alert alert-danger mt-2 mb-0">
                            <strong>This property is currently unavailable.</strong>
                        </div>
                    {% endif %}
                </div>

                <!-- Get Directions Button -->
                {% if property.latitude and property.longitude and property.latitude != 0 and property.longitude != 0 %}
                    <div class="mb-4">
                        <button class="btn btn-success w-100 btn-lg" id="get-directions-btn" onclick="getDirections()">
                            <i class="bi bi-geo-alt-fill"></i> Get Directions
                        </button>
                        <small class="text-muted d-block mt-2">
                            Click to open directions to this property in Google Maps
                        </small>
                    </div>
                {% endif %}

                <!-- Booking Form -->
                {% if not booking_request or booking_request.status == 'rejected' or booking_request.status == 'cancelled' %}
                    {% if user.is_authenticated %}
                        {% if user.profile.user_type == 'user' %}
                            <form method="post">
                                {% csrf_token %}
                                <div class="form-group mb-3">
                                    <label for="message">Message to Owner:</label>
                                    {{ form.message }}
                                </div>
                                <button type="submit" class="btn btn-primary w-100 btn-lg">
                                    <i class="bi bi-check-circle"></i> Send Booking Request
                                </button>
                            </form>
                        {% else %}
                            <div class="alert alert-warning">
                                Home owners cannot book properties. Please log in as a tenant.
                            </div>
                        {% endif %}
                    {% else %}
                        <p class="text-muted mb-3">Please log in to book this property</p>
                        <a href="/login/" class="btn btn-primary w-100 btn-lg">
                            Login to Book
                        </a>
                        <p class="text-center mt-3">
                            Don't have an account? <a href="/register/">Register here</a>
                        </p>
                    {% endif %}
                {% endif %}

                <!-- Price Summary -->
                <div class="bg-light p-3 rounded mt-4">
                    <h5 class="mb-3">Cost Breakdown</h5>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Monthly Rent:</strong></td>
                            <td class="text-end"><strong>‚Çπ{{ property.monthly_rent }}</strong></td>
                        </tr>
                        {% if property.maintenance_charges %}
                            <tr>
                                <td>Maintenance:</td>
                                <td class="text-end">‚Çπ{{ property.maintenance_charges }}</td>
                            </tr>
                        {% endif %}
                        <tr class="border-top">
                            <td><strong>Total Monthly:</strong></td>
                            <td class="text-end"><strong>‚Çπ{{ property.monthly_rent|add:property.maintenance_charges }}</strong></td>
                        </tr>
                        <tr>
                            <td><strong>Security Deposit:</strong></td>
                            <td class="text-end"><strong>‚Çπ{{ property.security_deposit }}</strong></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Google Maps API Script (for property detail map) -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}"></script>
<script>
    // Property coordinates
    const propertyLat = {{ property.latitude|default:"null" }};
    const propertyLng = {{ property.longitude|default:"null" }};
    const propertyAddress = "{{ property.full_address|escapejs }}";
    const propertyTitle = "{{ property.title|escapejs }}";
    
    // Initialize map only if booking is accepted and coordinates exist
    if (propertyLat && propertyLng && propertyLat !== 0 && propertyLng !== 0) {
        window.addEventListener('load', function() {
            initDetailMap();
        });

        function initDetailMap() {
            const mapElement = document.getElementById('property-map-detail');
            
            if (!mapElement) {
                return; // Map element not present (user not accepted booking)
            }

            const propertyLocation = { lat: propertyLat, lng: propertyLng };

            const map = new google.maps.Map(mapElement, {
                zoom: 16,
                center: propertyLocation,
                mapTypeControl: true,
                fullscreenControl: true,
                streetViewControl: true
            });

            // Add marker
            const marker = new google.maps.Marker({
                position: propertyLocation,
                map: map,
                title: propertyTitle,
                icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
            });

            // Add info window
            const infowindow = new google.maps.InfoWindow({
                content: '<div style="font-size: 14px;"><strong>' + propertyTitle + '</strong><br>' + propertyAddress + '<br>üìç Latitude: ' + propertyLat.toFixed(6) + '<br>Longitude: ' + propertyLng.toFixed(6) + '</div>'
            });

            marker.addListener('click', function() {
                infowindow.open(map, marker);
            });

            // Open info window by default
            infowindow.open(map, marker);
        }
    }

    // Function to get directions to the property
    function getDirections() {
        // Check if property has valid coordinates
        if (!propertyLat || !propertyLng || propertyLat === 0 || propertyLng === 0) {
            alert('‚ö† Property location coordinates are not available.');
            return;
        }

        // Check if geolocation is available
        if (!navigator.geolocation) {
            // Fallback: Show input modal for manual location entry
            showManualLocationModal();
            return;
        }

        // Show loading indicator
        const btn = document.getElementById('get-directions-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Getting your location...';
        btn.disabled = true;

        // Get user's current location
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                
                // Open Google Maps with directions
                openGoogleMapsDirections(userLat, userLng);
                
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            },
            function(error) {
                // If geolocation fails, show manual entry option
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                if (error.code === error.PERMISSION_DENIED) {
                    showManualLocationModal();
                } else {
                    alert('‚ö† Unable to get your location. Please allow location access or enter it manually.');
                    showManualLocationModal();
                }
            }
        );
    }

    // Function to open Google Maps with directions
    function openGoogleMapsDirections(userLat, userLng) {
        // Google Maps Directions URL format
        const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${propertyLat},${propertyLng}&travelmode=driving`;
        
        // Open in new tab
        window.open(mapsUrl, '_blank');
    }

    // Function to show manual location input modal
    function showManualLocationModal() {
        const modal = `
            <div class="modal fade" id="locationModal" tabindex="-1" role="dialog" aria-labelledby="locationModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="locationModalLabel">Enter Your Location</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted mb-3">We couldn't access your location automatically. Please enter it manually:</p>
                            <div class="mb-3">
                                <label for="userLatitude" class="form-label">Latitude:</label>
                                <input type="number" class="form-control" id="userLatitude" placeholder="e.g., 28.6139" step="0.000001">
                                <small class="form-text text-muted">Enter your current latitude</small>
                            </div>
                            <div class="mb-3">
                                <label for="userLongitude" class="form-label">Longitude:</label>
                                <input type="number" class="form-control" id="userLongitude" placeholder="e.g., 77.2090" step="0.000001">
                                <small class="form-text text-muted">Enter your current longitude</small>
                            </div>
                            <div class="alert alert-info small">
                                <strong>Don't know your coordinates?</strong><br>
                                You can find them on <a href="https://maps.google.com" target="_blank">Google Maps</a> by right-clicking on your location.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="processManualLocation()">Get Directions</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('locationModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modal);

        // Show modal
        const modal_element = document.getElementById('locationModal');
        const bsModal = new bootstrap.Modal(modal_element);
        bsModal.show();

        // Clean up modal on hide
        modal_element.addEventListener('hidden.bs.modal', function() {
            modal_element.remove();
        });
    }

    // Function to process manual location input
    function processManualLocation() {
        const userLat = parseFloat(document.getElementById('userLatitude').value);
        const userLng = parseFloat(document.getElementById('userLongitude').value);

        if (isNaN(userLat) || isNaN(userLng)) {
            alert('‚ö† Please enter valid latitude and longitude values.');
            return;
        }

        if (userLat < -90 || userLat > 90) {
            alert('‚ö† Latitude must be between -90 and 90.');
            return;
        }

        if (userLng < -180 || userLng > 180) {
            alert('‚ö† Longitude must be between -180 and 180.');
            return;
        }

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('locationModal')).hide();

        // Open Google Maps directions
        openGoogleMapsDirections(userLat, userLng);
    }
</script>

{% endblock %}

